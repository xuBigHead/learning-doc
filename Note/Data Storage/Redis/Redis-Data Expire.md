# 数据过期

Redis缓存数据过期时并不会立马删除，Redis 有两种删除过期数据的策略。

- 定期选取部分数据删除；
- 惰性删除。



## 语法

### 设置过期时间

```
EXPIRE key seconds [ NX | XX | GT | LT]
```



从 Redis 版本 7.0.0 开始：`EXPIRE` 添加了选项：`NX`、`XX`和`GT`、`LT` 选项。

- NX：当 key 没有过期时才设置过期时间；
- XX：只有 key 已过期的时候才设置过期时间；
- GT：仅当**新的到期时间**大于当前到期时间时才设置过期时间；
- LT：仅在新到期时间小于当前到期时间才设置到过期时间。



## 数据过期删除策略

### 惰性删除

惰性删除就是当有客户端的请求查询该 `key` 的时候，检查下 `key` 是否过期，如果过期，则删除该 `key`。**将删除过期数据的主动权交给了每次访问请求。**



### 定期删除

定期删除就是 Redis 默认每 1 秒运行 10 次（每 100 ms 执行一次），每次随机抽取一些（占25%）设置了过期时间的 key，检查是否过期，如果发现过期了就直接删除。



## 内存淘汰机制

- volatile为前缀的策略都是从已过期的数据集中进行淘汰。
- allkeys为前缀的策略都是面向所有key进行淘汰。
- LRU（least recently used）最近最少用到的。
- LFU（Least Frequently Used）最不常用的。
- 它们的触发条件都是Redis使用的内存达到阈值时。



## 集群或主从场景

在集群或主从场景下，为了保证数据一致性，让过期操作正常运行，机器之间的时间必须保证稳定同步，否则就会出现过期时间不准的情况。



比如两台时钟严重不同步的机器发生 RDB 传输， slave 的时间设置为未来的 2000 秒，假如在 master 的一个 key 设置 1000 秒存活，当 Slave 加载 RDB 的时候 key 就会认为该 key 过期（因为 slave 机器时间设置为未来的 2000 s），并不会等待 1000 s 才过期。